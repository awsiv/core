CFEngine 3 Nova
Release date: October 25th, 2011
Scope: Official release of CFEngine 3 Nova.

Platforms supported: 
Hub:  Debian 5, Debian 6, Ubuntu 8, Ubuntu 10, RHEL 5, RHEL 6, SLES/openSUSE 11
Clients: Debian 5, Debian 6, RHEL 4, RHEL 5, RHEL 6, SLES/openSUSE 9, SLES/openSUSE 10, SLES/openSUSE 11, Ubuntu 8, Ubuntu 9, Ubuntu 10, Ubuntu 11, Fedora 14, Fedora 15, FreeBSD 7, FreeBSD 8, NetBSD 4, NetBSD 5, AIX 5, AIX 6, Solaris (sparc) 8, Solaris (sparc) 9, Solaris (sparc) 10, Solaris (x86) 10, Windows Server 2003, Windows Server 2008.

Community version base: 3.2.3

Compatibility matrix: 
HUB	CLIENT		TESTED		SUPPORTED
2.1.x	2.1		Yes		Yes
2.1.x	2.0.x		Yes		Yes (vital signs will be incomplete)
2.0.x	2.1.x		Yes		No  (always run same or newer version of HUB than Client)


CHANGE LOG FROM 2.0.4:
* Completely new Mission portal utilizing Javascript for improved user experience (supported browsers: IE8 upwards, Firefox, Opera, Chrome, Safari)
* New and updated modules in Mission Portal: Finders, Viewers, and Editors
* Paged reporting for improved scalability on web interface (data will not be truncated)
* Expanded monitoring on Linux and Solaris (cf-agents will report more basic data, such as load and cpu, "vital signs")
* Faster collection of monitoring data due to new protocol and data structure
* Long-term storage (one year) of diff and changes reports.
* Command line reporting tool (cf-report, see Special Topic on Reporting)
* MySQL is fully replaced by MongoDB for all internal CFEngine data handling
* High availability hub configuration (redundant hubs, see Special Topics guide)
* New category for unreachable hosts (blue hosts)
* User management system with individual groups and user accounts (Admin, Developer, Manager, Faculty, etc.)
* External authentication for Mission Portal (LDAP, Active Directory)
* Collaboration tools: Store notes, publish messages/status per user account, activity log.
* Save searches (from report queries)
* Support for multiple release environments, for example staging and production from one Hub.
* Improved data transportation protocol efficiency (not backwards compatible but will fallback to legacy protocol if not supported on both sides)
* Improved knowledge map
* Higher level goals can have custom names
* Ability to set Mission Portal user preferences (tooltips on/off, report page size)
* Ability to save subversion repository settings
* Approve policy changes (integrated with policy editor/subversion)
* New report category shows current promise compliance (summary report)
* New option cf-hub --cache, recreates the cache data needed by the web interface.

* Changes in default policies (see /var/cfengine/masterfiles/Changelog)

Bug fixes since 2.0.4
* Listing of hosts was under certain circumstances limited to 1000 (now unlimited)
* Buffer limits increased to avoid truncating of reports (buffer limit warning displayed in Mission Portal)
* Improved forking of cf-hub (to improve parallellized scans from the hub; improved scalability)
* Fixed file transfer issues that could occur under unreliable network connections

See https://cfengine.com/bugtracker/changelog_page.php for change log related to the CFEngine Community Core (version 3.1.5 to 3.2.3).


INSTALLATION INSTRUCTIONS AND SOFTWARE DEPENDENCIES (specific to CFEngine 3 Nova)
* Clean install is tested, upgrade from previous version of NOVA tested (see upgrade procedure below).
* As always, install HUB first, then client(s).
* For large systems (> 1000 hosts) we recommend increasing the memory limit in php.conf on the HUB (for instance to 128 MB)
* REFER TO INSTALLATION.TXT for detailed instructions.


UPGRADE PROCEDURE

Starting with the HUB:
1) Stop all CFE processes
 $ /etc/init.d/cfengine3 stop
 or
 $ for i in cf-execd cf-serverd cf-monitord cf-hub mongod; do pkill $i; done

2) Upgrade cfengine-nova and cfengine-nova-expansion
 [Redhat/CentOS/SUSE]
 $ rpm -Uvh /tmp/cfengine-nova-2.1.x-y.x86_64.rpm /tmp/cfengine-nova-expansion-2.1.x-y5.x86_64.rpm
 [Debian/Ubuntu]
 $ dpkg --install /tmp/cfengine-nova_2.1.x-y_x86_64.deb /tmp/cfengine-nova-expansion_2.1.x-y_x86_64.deb

3) Nova's dependency has changed so we have to correct cf-twin (libgd and libmysqlclient were removed)
 $ cp /var/cfengine/bin/cf-agent /var/cfengine/bin/cf-twin

4) Remove database lock if present
   $ rm /var/cfengine/state/mongod.lock


5) Copy new CFE policy files to $(sys.workdir)/masterfiles. The files with a prefix "CFE_" will be handled by CFEngine, do not make changes to these. They are mostly renamed versions of old files (cfengine.cf, knowledge.cf, etc) where we have added some promises to ensure that the Mission Portal will work properly.

 $ cd /var/cfengine/master_software_updates/NovaBase
 $ cp CFE_cfengine.cf CFE_knowledge.cf CFE_hub_specific.cf company_knowledge.cf cfengine_stdlib.cf /var/cfengine/masterfiles

 ***comments***
  * CFE_cfengine.cf
    - contains "bundle agent cfengine_management{}" and agent bundles for all Nova hosts.
  * CFE_knowledge.cf
    - mostly Nova Knowledge Map setup
  * CFE_hub_specific.cf
    - all necessary bundles to build the Nova HUB is in this file
  * company_knowledge.cf
    - a custom Knowledge Map configuration. You may add any information you'd like to populate the Nova Knowledge Map later on 
  * cfengine_stdlib.cf
    - the latest standard CFE bodies and bundles

6) modify contents in promises.cf
 * correct input files in "inputs => {}";
  - change cfengine.cf to CFE_cfengine.cf
  - change knowledge.cf to CFE_knowledge.cf
  - add CFE_hub_specific.cf

   inputs => {
              "CFE_cfengine.cf",
              "CFE_hub_specific.cf",
              "CFE_knowledge.cf",
              "update.cf",
              "cfengine_stdlib.cf",
              "environment_$(environments.active)/promises.cf",
             };

 * add "commercial_customer" class to "bundle common def{}"
 classes:
  "commercial_customer" or => { "nova_edition", "constellation_edition" },
                   comment => "Define a global class for CFE Nova and Constellation",
                    handle => "common_def_classes_commercial_customer";

 * delete the whole "bundle agent cfengine_management{}" (It was moved to CFE_hub_specific.cf)

 * add "track_value" to "body agent control{}"
 any:
  track_value => "true";

7) tidy up $(sys.doc_root) directory
 [Debian/Ubuntu]
 $ rm -rf /var/www/*
 [RHEL/CentOS]
 $ rm -rf /var/www/html/*
 [SLES/openSUSE]
 $ rm -rf /srv/www/htdocs/*

8) restart CFE processes
 $ /etc/init.d/cfengine 3 start
 or
 $ /var/cfengine/bin/cf-execd

9) You will need to re-initialize the MongoDB if you have trouble logging in after upgrade. Run the following command:
 [RHEL 5,6 / CentOS 5]
 $ /var/cfengine/bin/mongorestore -d phpcfengine /var/www/html/phpcfenginenova
 [SLES 11 / OpenSuSE 11]
 $ /var/cfengine/bin/mongorestore -d phpcfengine /srv/www/htdocs/phpcfenginenova
 [Debian 5,6 / Ubuntu 8,10]
 $ /var/cfengine/bin/mongorestore -d phpcfengine /var/www/phpcfenginenova

For client upgrades there are 2 approaches: doing it manually or automatically.
[manually]
 - simply update cfengine-nova by rpm/dpkg command and replace cf-twin as described in step 3 above (i.e. overwrite the old cf-twin).
[automatically]
 - put cfengine-nova packages to client's distribution and architecture directories in /var/cfengine/master_software_updates and CFEngine Nova will take care of the rest


KNOWN ISSUES:
* Internet Explorer v6 not supported (and so it will remain)
* Incoming connections from Community edition clients can not be tracked from the Nova hub
* Reports can not be collected from client if initial bootstrap fails due to incorrect or corrupted policy files
* Can not add notes in file change log in cases where file is not found
* Inability to connect to the database while querying for reports is handled as an empty result set by the Mission Portal

